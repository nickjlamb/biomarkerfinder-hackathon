<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cross-Disease Biomarker Visualizer</title>
  <!-- FontAwesome for icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <!-- Vis.js Network CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.2/dist/vis-network.min.css" rel="stylesheet" type="text/css" />
</head>
<body>
<!-- Full-width wrapper -->
<div style="background-color: #ffffff; padding: 50px 60px;">

  <!-- Centered content -->
  <div style="max-width: 1200px; margin: 0 auto; font-family: 'Segoe UI', sans-serif; background-color: #f4f6fb; padding: 30px 60px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
    
    <!-- Collapsible Section -->
    <div class="kg-section">
      <button class="kg-toggle-button">
        <span class="kg-icon">ðŸ”¬</span>
        Compare Cross-Disease Biomarkers
      </button>
      
      <!-- Collapsible Content Area -->
      <div class="kg-content-area">
        <p style="color: #333; margin-bottom: 20px; font-size: 16px; line-height: 1.6;">
          Select two or more diseases to visualize shared and unique targets. This can help uncover hidden relationships and potential new therapeutic avenues.
        </p>
        
        <!-- Disease Search Inputs -->
        <div id="disease-inputs-container" style="margin-bottom: 20px;">
          <!-- Initial search boxes will be added here by JS -->
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
          <button id="add-disease-btn" class="kg-utility-btn">
            <i class="fas fa-plus" style="margin-right: 8px;"></i>Add Disease
          </button>
          <button id="visualize-btn" class="kg-visualize-btn">
            <i class="fas fa-project-diagram" style="margin-right: 8px;"></i>Visualize
          </button>
        </div>
        
        <p id="error-message" style="text-align: center; color: #d62828; font-weight: 500; min-height: 24px;"></p>
        
        <!-- Layer Visibility Controls -->
        <div id="visibility-controls" style="display: none; margin-bottom: 15px; padding: 15px; background-color: #e9ecef; border-radius: 8px;">
          <h4 style="margin-top: 0; margin-bottom: 10px; color: #333;">Layer Visibility</h4>
          <div class="toggle-container">
            <label><input type="checkbox" class="visibility-toggle" data-group="disease" checked> Diseases</label>
            <label><input type="checkbox" class="visibility-toggle" data-group="target" checked> Targets</label>
            <label><input type="checkbox" class="visibility-toggle" data-group="drug" checked> Drugs</label>
          </div>
        </div>

        <div id="knowledge-graph-container" style="position: relative; min-height: 800px; background-color: #e9ecef; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #6c757d; font-style: italic; transition: all 0.3s;">
          Knowledge Graph will appear here...
          <div id="kg-controls" style="position: absolute; top: 10px; right: 10px; z-index: 1000; display: none;">
            <button id="focus-mode-btn" class="kg-graph-btn" title="Enter Focus Mode"><i class="fas fa-expand"></i></button>
            <button id="exit-focus-mode-btn" class="kg-graph-btn" title="Exit Focus Mode" style="display: none;"><i class="fas fa-compress"></i></button>
          </div>
        </div>
      </div>
    </div>

    <style>
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow-x: hidden; /* Prevent horizontal scroll */
      }
      .toggle-container {
        display: flex;
        gap: 20px;
        align-items: center;
      }
      .toggle-container label {
        font-size: 15px;
        color: #555;
        display: flex;
        align-items: center;
        cursor: pointer;
      }
      .toggle-container input {
        margin-right: 8px;
        width: 18px;
        height: 18px;
      }
      .kg-section {
        border-bottom: 1px solid #e2e8f0;
        margin-bottom: 12px;
        padding-bottom: 8px;
      }
      .kg-toggle-button {
        background: none;
        border: none;
        color: #2036F5;
        font-size: 22px;
        font-weight: bold;
        padding: 12px 0;
        text-align: left;
        width: 100%;
        cursor: pointer;
        display: flex;
        align-items: center;
        transition: color 0.3s ease;
      }
      .kg-toggle-button:hover {
        color: #0f1cc9;
      }
      .kg-icon {
        margin-right: 12px;
        transition: transform 0.3s ease;
      }
      .kg-content-area {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.5s ease-in-out, padding 0.4s ease, opacity 0.5s ease;
        opacity: 0;
      }
      .kg-section.active .kg-content-area {
        max-height: 1500px; /* Large enough value for content */
        padding-top: 20px;
        padding-bottom: 10px;
        opacity: 1;
      }
      .kg-toggle-button::after {
        content: "âž•";
        margin-left: auto;
        font-size: 16px;
        transition: transform 0.3s ease;
      }
      #disease-inputs-container {
        max-width: 700px;
        margin-left: auto;
        margin-right: auto;
      }
      .kg-section.active .kg-toggle-button::after {
        content: "âž–";
      }
      .kg-section.active .kg-icon {
        transform: rotate(10deg);
      }
      .disease-input-group {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
      }
      .disease-input-group input {
        flex: 1;
        width: 100%;
        padding: 12px 16px;
        font-size: 16px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        background-color: #fff;
        transition: border-color 0.3s, box-shadow 0.3s;
        outline: none;
      }
      .disease-input-group input:focus {
        border-color: #4cc9f0;
        box-shadow: 0 0 0 4px rgba(76, 201, 240, 0.2);
      }
      .remove-disease-btn {
        background-color: #ef476f;
        color: white;
        border: none;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.3s, transform 0.2s;
        position: relative;
        z-index: 2;
      }
      .remove-disease-btn:hover {
        background-color: #d62828;
        transform: scale(1.1);
      }
      .kg-utility-btn {
        background-color: #fff;
        color: #4361ee;
        border: 2px solid #4361ee;
        border-radius: 8px;
        padding: 10px 16px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
      }
      .kg-utility-btn:hover {
        background-color: #f0f2ff;
      }
      .kg-visualize-btn {
        background: linear-gradient(135deg, #4361ee, #3a0ca3 70%);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 12px 24px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 4px 12px rgba(67, 97, 238, 0.2);
      }
      .kg-visualize-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(67, 97, 238, 0.3);
      }
      .input-wrapper {
        position: relative;
        flex: 1;
      }
      .autocomplete-suggestions {
        position: absolute;
        border: 1px solid #ddd;
        border-top: none;
        z-index: 100;
        background-color: white;
        border-radius: 0 0 8px 8px;
        box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        max-height: 250px;
        overflow-y: auto;
        width: 100%;
        top: 100%;
        left: 0;
        display: none;
      }
      .suggestion-item {
        padding: 12px 16px;
        cursor: pointer;
        font-size: 15px;
      }
      .suggestion-item:hover {
        background-color: #f1f1f1;
      }
      .kg-graph-btn {
        background-color: rgba(255, 255, 255, 0.8);
        border: 1px solid #ccc;
        border-radius: 8px;
        width: 40px;
        height: 40px;
        cursor: pointer;
        font-size: 16px;
        backdrop-filter: blur(5px);
      }
      .kg-graph-btn:hover {
        background-color: white;
      }
      #knowledge-graph-container.focus-mode {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: 9999;
        border-radius: 0;
      }
      #knowledge-graph-container .vis-network {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
      }

      /* Mobile Responsive Styles */
      @media (max-width: 768px) {
        body > div {
          padding: 30px 20px !important;
        }

        body > div > div {
          padding: 20px 24px !important;
        }

        .kg-toggle-button {
          font-size: 18px;
          padding: 10px 0;
        }

        .kg-section.active .kg-content-area p {
          font-size: 15px;
          line-height: 1.5;
        }

        .disease-input-group {
          flex-direction: column;
          gap: 8px;
        }

        .disease-input-group input {
          width: 100%;
          padding: 12px 14px;
          font-size: 15px;
        }

        .remove-disease-btn {
          align-self: flex-end;
          margin-top: -8px;
        }

        div[style*="display: flex"][style*="justify-content: space-between"] {
          flex-direction: column !important;
          gap: 12px;
          align-items: stretch !important;
        }

        .kg-utility-btn,
        .kg-visualize-btn {
          width: 100%;
          justify-content: center;
          padding: 12px 20px;
          font-size: 15px;
        }

        #knowledge-graph-container {
          min-height: 500px;
        }

        .toggle-container {
          flex-direction: column;
          align-items: flex-start;
          gap: 12px;
        }
      }

      @media (max-width: 480px) {
        body > div {
          padding: 20px 12px !important;
        }

        body > div > div {
          padding: 16px 16px !important;
        }

        .kg-toggle-button {
          font-size: 16px;
          line-height: 1.3;
        }

        .kg-icon {
          margin-right: 8px;
        }

        .kg-section.active .kg-content-area p {
          font-size: 14px;
          margin-bottom: 16px;
        }

        .disease-input-group input {
          padding: 10px 12px;
          font-size: 14px;
        }

        .kg-utility-btn,
        .kg-visualize-btn {
          padding: 10px 16px;
          font-size: 14px;
        }

        #knowledge-graph-container {
          min-height: 400px;
        }

        #visibility-controls {
          padding: 12px;
        }

        #visibility-controls h4 {
          font-size: 14px;
          margin-bottom: 8px;
        }

        .toggle-container label {
          font-size: 13px;
        }
      }
    </style>
  </div>
</div>

<!-- Vis.js Network Library -->
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.2/dist/vis-network.min.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const kgButton = document.querySelector(".kg-toggle-button");
    const inputsContainer = document.getElementById("disease-inputs-container");
    const addBtn = document.getElementById("add-disease-btn");
    const visualizeBtn = document.getElementById('visualize-btn');
    const graphContainer = document.getElementById('knowledge-graph-container');
    const controlsContainer = document.getElementById('kg-controls');
    const focusBtn = document.getElementById('focus-mode-btn');
    const exitFocusBtn = document.getElementById('exit-focus-mode-btn');
    const visibilityControls = document.getElementById('visibility-controls');
    const errorMessage = document.getElementById('error-message');
    let diseaseCount = 0;
    let diseaseData = [];
    let activeAutocomplete = null;
    let network = null;
    let originalColors = {};

    // --- Data Fetching and Graph Logic ---
    async function fetchDiseases() {
      try {
        const response = await fetch('https://gist.githubusercontent.com/nickjlamb/ead9c82885eb568ed5b8868c5faa0e29/raw/combined_diseases.json');
        const data = await response.json();
        diseaseData = data.data.search.hits.map(hit => ({
          name: hit.object.name,
          id: hit.object.id
        }));
      } catch (error) {
        console.error("Failed to load disease list:", error);
        graphContainer.textContent = 'Error: Could not load disease data.';
      }
    }

    async function fetchTargetsForDisease(efoId) {
      const query = `
        query {
          disease(efoId: "${efoId}") {
            associatedTargets(page: {index: 0, size: 10}) {
              rows {
                target {
                  id
                  approvedSymbol
                }
              }
            }
          }
        }`;
      const response = await fetch("https://api.platform.opentargets.org/api/v4/graphql", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ query }),
      });
      const json = await response.json();
      return json.data.disease.associatedTargets.rows.map(row => row.target);
    }

    async function fetchDrugsForTarget(targetId) {
        const query = `
            query {
                target(ensemblId: "${targetId}") {
                    knownDrugs {
                        rows {
                            drug {
                                id
                                name
                            }
                        }
                    }
                }
            }`;
        const response = await fetch("https://api.platform.opentargets.org/api/v4/graphql", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ query }),
        });
        const json = await response.json();
        if (json.data.target && json.data.target.knownDrugs) {
            return json.data.target.knownDrugs.rows.map(row => row.drug);
        }
        return [];
    }

    function renderGraph(nodes, edges) {
        graphContainer.innerHTML = '';
        graphContainer.appendChild(controlsContainer); // Re-append controls
        controlsContainer.style.display = 'block';
        visibilityControls.style.display = 'block'; // Show visibility controls
        graphContainer.style.backgroundColor = '#ffffff';
        
        const data = { nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges) };
        const options = {
            nodes: {
                shape: 'dot',
                size: 20,
                font: { size: 14, color: '#333' },
                borderWidth: 2,
            },
            edges: {
                width: 2,
                color: { inherit: 'from' },
                smooth: { type: 'continuous' }
            },
            groups: {
                disease: { color: { background: '#4361ee', border: '#3a0ca3' }, font: { color: 'black' } },
                target: { color: { background: '#ffd166', border: '#e2b748' } },
                sharedTarget: { color: { background: '#ef476f', border: '#d62828' }, shape: 'diamond', size: 25 },
                drug: { color: { background: '#06d6a0', border: '#04a37a' }, shape: 'box' }
            },
            physics: {
                solver: 'forceAtlas2Based',
                forceAtlas2Based: {
                    gravitationalConstant: -80,
                    centralGravity: 0.01,
                    springLength: 250,
                    springConstant: 0.09,
                },
                stabilization: { iterations: 100 }
            },
            interaction: {
                hover: true,
                tooltipDelay: 200,
            }
        };
        
        // Store original colors for the toggles
        originalColors = {
            disease: options.groups.disease.color,
            target: options.groups.target.color,
            sharedTarget: options.groups.sharedTarget.color,
            drug: options.groups.drug.color
        };

        network = new vis.Network(graphContainer, data, options);
        
        // Ensure the network is sized correctly on initial render
        resizeNetwork();
    }

    visualizeBtn.addEventListener('click', async () => {
        errorMessage.textContent = ''; // Clear previous errors
        if (activeAutocomplete) activeAutocomplete.style.display = 'none';
        
        const inputs = Array.from(document.querySelectorAll('.disease-input'));
        const diseaseNames = inputs.map(input => input.value.trim()).filter(val => val);

        if (diseaseNames.length < 2) {
            errorMessage.textContent = 'Please enter at least two valid diseases to compare.';
            return;
        }

        graphContainer.textContent = 'Fetching data from Open Targets...';
        graphContainer.style.backgroundColor = '#d1d9e6';

        const diseaseInfo = diseaseNames.map(name => diseaseData.find(d => d.name.toLowerCase() === name.toLowerCase())).filter(d => d);
        
        if (diseaseInfo.length !== diseaseNames.length) {
            errorMessage.textContent = 'One or more disease names are not valid. Please use the autocomplete suggestions.';
            graphContainer.textContent = 'Knowledge Graph will appear here...'; // Reset graph area
            return;
        }

        try {
            // Step 1: Fetch all targets for the selected diseases
            const targetPromises = diseaseInfo.map(d => fetchTargetsForDisease(d.id));
            const results = await Promise.all(targetPromises);

            const nodes = new Map();
            const edges = [];
            const targetConnections = new Map();
            const allTargets = new Map();

            // Step 2: Create disease nodes and collect all unique targets
            diseaseInfo.forEach((disease, i) => {
                nodes.set(disease.id, { id: disease.id, label: disease.name, group: 'disease', size: 30, title: `Disease: ${disease.name}` });
                
                const targets = results[i];
                targets.forEach(target => {
                    if (!allTargets.has(target.id)) {
                        allTargets.set(target.id, target);
                    }
                    targetConnections.set(target.id, (targetConnections.get(target.id) || 0) + 1);
                    edges.push({ from: disease.id, to: target.id });
                });
            });

            // Step 3: Create target nodes
            allTargets.forEach(target => {
                nodes.set(target.id, { id: target.id, label: target.approvedSymbol, group: 'target', title: `Target: ${target.approvedSymbol}` });
            });

            // Step 4: Fetch drugs for all unique targets
            graphContainer.textContent = `Found ${allTargets.size} targets. Now fetching associated drugs...`;
            const drugPromises = Array.from(allTargets.keys()).map(fetchDrugsForTarget);
            const drugResults = await Promise.all(drugPromises);

            // Step 5: Create drug nodes and connect them to targets
            drugResults.forEach((drugs, i) => {
                const targetId = Array.from(allTargets.keys())[i];
                drugs.forEach(drug => {
                    if (!nodes.has(drug.id)) {
                        nodes.set(drug.id, { id: drug.id, label: drug.name, group: 'drug', title: `Drug: ${drug.name}` });
                    }
                    edges.push({ from: targetId, to: drug.id });
                });
            });

            // Step 6: Update shared targets' appearance
            nodes.forEach(node => {
                if (node.group === 'target' && targetConnections.get(node.id) > 1) {
                    node.group = 'sharedTarget';
                    node.title = `Shared Target: ${node.label}\n(Connected to ${targetConnections.get(node.id)} diseases)`;
                }
            });

            if (nodes.size === 0) {
                graphContainer.textContent = 'No target associations found for the selected diseases.';
                return;
            }

            renderGraph(Array.from(nodes.values()), edges);

        } catch (error) {
            console.error("Failed to fetch or render graph:", error);
            graphContainer.textContent = 'An error occurred. Please check the console for details.';
        }
    });

    // --- UI Management ---
    function attachAutocomplete(inputElement) {
      const wrapper = inputElement.parentElement;
      const suggestionsContainer = wrapper.querySelector('.autocomplete-suggestions');

      inputElement.addEventListener("input", () => {
        const value = inputElement.value.toLowerCase();
        document.querySelectorAll('.autocomplete-suggestions').forEach(s => {
            if (s !== suggestionsContainer) s.style.display = 'none';
        });

        if (!value) {
          suggestionsContainer.style.display = 'none';
          return;
        }
        const matches = diseaseData.map(d => d.name).filter(name => name.toLowerCase().includes(value)).slice(0, 10);
        
        if (matches.length > 0) {
          suggestionsContainer.innerHTML = matches.map(match => `<div class="suggestion-item">${match}</div>`).join('');
          suggestionsContainer.style.display = 'block';
          activeAutocomplete = suggestionsContainer;
        } else {
          suggestionsContainer.style.display = 'none';
        }
      });

      suggestionsContainer.addEventListener("click", (e) => {
        if (e.target.classList.contains("suggestion-item")) {
          inputElement.value = e.target.textContent;
          suggestionsContainer.style.display = 'none';
        }
      });
    }

    const addDiseaseInput = () => {
      diseaseCount++;
      const inputGroup = document.createElement('div');
      inputGroup.className = 'disease-input-group';
      inputGroup.innerHTML = `
        <div class="input-wrapper">
          <input type="text" placeholder="Enter disease #${diseaseCount}..." class="disease-input" autocomplete="off">
          <div class="autocomplete-suggestions"></div>
        </div>
        <button class="remove-disease-btn" title="Remove disease">&times;</button>
      `;
      inputsContainer.appendChild(inputGroup);
      attachAutocomplete(inputGroup.querySelector('.disease-input'));
    };

    addDiseaseInput();
    addDiseaseInput();

    kgButton.addEventListener("click", () => kgButton.closest(".kg-section").classList.toggle("active"));
    addBtn.addEventListener("click", addDiseaseInput);

    inputsContainer.addEventListener("click", (e) => {
      if (e.target.classList.contains("remove-disease-btn")) {
        e.target.closest('.disease-input-group').remove();
      }
    });

    document.addEventListener("click", (e) => {
        if (activeAutocomplete && !e.target.closest('.input-wrapper')) {
            activeAutocomplete.style.display = 'none';
            activeAutocomplete = null;
        }
    });

    // --- Visibility Toggle Logic ---
    function hexToRgba(hex, alpha) {
        const r = parseInt(hex.slice(1, 3), 16);
        const g = parseInt(hex.slice(3, 5), 16);
        const b = parseInt(hex.slice(5, 7), 16);
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }

    document.querySelectorAll('.visibility-toggle').forEach(toggle => {
        toggle.addEventListener('change', (e) => {
            if (!network) return;
            const group = e.target.dataset.group;
            const isVisible = e.target.checked;

            const groupsToUpdate = (group === 'target') ? ['target', 'sharedTarget'] : [group];

            groupsToUpdate.forEach(g => {
                const nodesToUpdate = network.body.data.nodes.get({
                    filter: node => node.group === g
                });

                if (nodesToUpdate.length > 0) {
                    const newColor = isVisible 
                        ? originalColors[g]
                        : {
                            background: hexToRgba(originalColors[g].background, 0.02),
                            border: hexToRgba(originalColors[g].border, 0.05)
                          };
                    
                    const updates = nodesToUpdate.map(node => ({ id: node.id, color: newColor }));
                    network.body.data.nodes.update(updates);
                }
            });
        });
    });

    // Focus Mode Logic
    const toggleFocusMode = () => {
        graphContainer.classList.toggle('focus-mode');
        focusBtn.style.display = graphContainer.classList.contains('focus-mode') ? 'none' : 'block';
        exitFocusBtn.style.display = graphContainer.classList.contains('focus-mode') ? 'block' : 'none';
        
        // Give the CSS transition time to finish before resizing the network
        setTimeout(() => {
            resizeNetwork();
        }, 300); // 300ms matches the CSS transition time
    };

    const resizeNetwork = () => {
        if (network) {
            network.setOptions({ 
                width: graphContainer.clientWidth + 'px', 
                height: graphContainer.clientHeight + 'px' 
            });
            network.fit();
            // Set a more reasonable default zoom after fitting
            network.moveTo({ scale: 0.75 });
        }
    };

    focusBtn.addEventListener('click', toggleFocusMode);
    exitFocusBtn.addEventListener('click', toggleFocusMode);
    window.addEventListener('resize', resizeNetwork);

    document.addEventListener('keydown', (e) => {
        if (e.key === "Escape" && graphContainer.classList.contains('focus-mode')) {
            toggleFocusMode();
        }
    });

    fetchDiseases();
  });
</script>
</body>
</html>
