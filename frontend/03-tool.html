<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BiomarkerFinder</title>

  <!-- @risg99 - Start of Cytoscape.js script -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.26.0/cytoscape.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/cytoscape-qtip@2.7.0/cytoscape-qtip.min.js"></script>
  <!-- @risg99 - End of Cytoscape.js script -->

  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

  <!-- @risg99 - Start of Export button styling JS Script -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- @risg99 - End of Export button styling JS Script -->

  <style>
    :root {
      --primary: #4361ee;
      --primary-gradient: linear-gradient(135deg, #4361ee, #3a0ca3 70%);
      --secondary: #7209b7;
      --accent: #4cc9f0;
      --text-primary: #2b2d42;
      --text-secondary: #6c757d;
      --bg-primary: #ffffff;
      --bg-secondary: #f8f9fa;
      --bg-card: #ffffff;
      --success: #06d6a0;
      --warning: #ffd166;
      --danger: #ef476f;
      --border-radius: 12px;
      --card-shadow: 0 10px 20px rgba(67, 97, 238, 0.07), 0 6px 6px rgba(67, 97, 238, 0.06);
      --header-height: 120px;
      --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }

    body {
      background-color: var(--bg-secondary);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.7;
      overflow-x: hidden;
    }

    .container {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 30px;
    }

    .app-wrapper {
      position: relative;
    }

    .header {
      background: var(--primary-gradient);
      position: relative;
      padding-top: 45px;
      padding-bottom: 45px;
      overflow: hidden;
    }

    .header-content {
      position: relative;
      z-index: 2;
      opacity: 0;
      transform: translateY(20px);
      animation: fadeInHeader 1s ease forwards;
    }

    @keyframes fadeInHeader {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .app-title {
      display: flex;
      align-items: center;
      color: white;
      font-weight: 700;
      font-size: 36px;
      margin-bottom: 30px;
      letter-spacing: -0.5px;
    }

    .app-title .icon {
      margin-right: 12px;
      font-size: 32px;
      background: rgba(255, 255, 255, 0.2);
      width: 52px;
      height: 52px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 10px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 0 15px rgba(67, 97, 238, 0.3);
    }

    .app-description {
      color: rgba(255, 255, 255, 0.9);
      font-size: 16px;
      margin-bottom: 20px;
      max-width: 600px;
      line-height: 1.5;
    }

    .search-container {
      position: relative;
      z-index: 3;
      background-color: var(--bg-card);
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      padding: 20px;
      margin-top: -40px;
    }

    .input-group {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .input-container {
      position: relative;
      flex: 1;
    }

    #diseaseInput {
      width: 100%;
      padding: 16px 90px 16px 20px;
      font-size: 16px;
      border: 2px solid #e9ecef;
      border-radius: 20px;
      background-color: var(--bg-secondary);
      transition: border-color 0.3s, box-shadow 0.3s;
      outline: none;
    }

    #diseaseInput:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 4px rgba(76, 201, 240, 0.2);
    }

    .input-icon {
      position: absolute;
      right: 60px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-secondary);
      pointer-events: none;
      transition: var(--transition);
    }

    .mic-btn {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      width: 40px;
      height: 40px;
      border: none;
      background: white;
      border-radius: 10px;
      color: #667eea;
      font-size: 18px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .mic-btn:hover {
      background: #667eea;
      color: white;
      transform: translateY(-50%) scale(1.05);
    }

    .mic-btn.listening {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      animation: pulse 1.5s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7); }
      50% { box-shadow: 0 0 0 10px rgba(102, 126, 234, 0); }
    }

    .voice-selector {
      padding: 12px 16px;
      border: 2px solid #e9ecef;
      border-radius: 12px;
      background: white;
      font-size: 14px;
      color: #2d3748;
      cursor: pointer;
      transition: all 0.3s ease;
      outline: none;
      min-width: 200px;
    }

    .voice-selector:hover {
      border-color: #667eea;
    }

    .voice-selector:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    #diseaseInput:focus+.input-icon {
      color: var(--accent);
    }

    #getBiomarkersBtn {
      background: var(--primary-gradient);
      color: white;
      border: none;
      border-radius: var(--border-radius);
      padding: 16px 24px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      box-shadow: 0 4px 12px rgba(67, 97, 238, 0.2);
      display: flex;
      align-items: center;
      gap: 10px;
      white-space: nowrap;
    }

    #getBiomarkersBtn:hover {
      background: linear-gradient(135deg, #3a0ca3, #4361ee);
    }

    #getBiomarkersBtn:active {
      transform: translateY(0);
    }

    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top: 3px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .progress-container {
      background: #f7fafc;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 24px;
      display: none;
    }

    .progress-container.show {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    .progress-bar {
      width: 100%;
      height: 4px;
      background: #e2e8f0;
      border-radius: 2px;
      overflow: hidden;
      margin-bottom: 12px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%);
      width: 0%;
      transition: width 0.5s ease;
      border-radius: 2px;
    }

    .progress-steps {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .progress-spinner {
      width: 20px;
      height: 20px;
      border: 2px solid #e2e8f0;
      border-top: 2px solid #4361ee;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    .progress-text {
      font-size: 14px;
      color: #4a5568;
      font-weight: 500;
    }

    .recent-searches {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .recent-search-tag {
      background-color: rgba(67, 97, 238, 0.1);
      color: var(--primary);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 13px;
      cursor: pointer;
      transition: transform 0.3s, box-shadow 0.3s;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }

    .recent-search-tag:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 10px rgba(0, 0, 0, 0.1);
    }

    .output-container {
      padding: 20px 0;
    }

    .biomarker-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .biomarker-card {
      background-color: var(--bg-card);
      border-radius: var(--border-radius);
      padding: 30px;
      box-shadow: var(--card-shadow);
      transition: var(--transition);
      position: relative;
      overflow: hidden;
      background: linear-gradient(135deg, #ffffff, #f8f9fa);
    }

    .biomarker-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 30px rgba(67, 97, 238, 0.1), 0 10px 10px rgba(67, 97, 238, 0.05);
    }

    .biomarker-type {
      display: inline-block;
      background-color: #EDF2F7;
      color: #4A5568;
      font-weight: 600;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 13px;
      margin-bottom: 15px;
      text-transform: capitalize;
    }

    .biomarker-type.predictive {
      background-color: #E6FFFA;
      color: #047857;
    }

    .biomarker-type.prognostic {
      background-color: #FEF3C7;
      color: #B45309;
    }

    .biomarker-type.diagnostic {
      background-color: #FEE2E2;
      color: #B91C1C;
    }

    .biomarker-type .icon {
      margin-right: 5px;
    }

    .biomarker-name {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 5px;
      color: var(--text-primary);
      letter-spacing: -0.5px;
    }

    .biomarker-gene {
      color: var(--text-secondary);
      font-size: 15px;
      margin-bottom: 15px;
    }

    .biomarker-score {
      position: relative;
      display: flex;
      align-items: center;
      margin: 8px 0;
    }

    .score-label {
      font-weight: 600;
      font-size: 15px;
      margin-right: 10px;
      display: flex;
      align-items: center;
    }

    .tooltip-icon {
      display: inline-block;
      width: 16px;
      height: 16px;
      background-color: #E2E8F0;
      color: #4A5568;
      border-radius: 50%;
      text-align: center;
      line-height: 16px;
      font-size: 12px;
      margin-left: 5px;
      cursor: help;
      position: relative;
      font-weight: 700;
    }

    .tooltip {
      visibility: hidden;
      position: absolute;
      background-color: #1A202C;
      color: white;
      text-align: left;
      padding: 10px 12px;
      border-radius: 6px;
      z-index: 1;
      opacity: 0;
      transition: opacity 0.3s;
      font-weight: normal;
      font-size: 12px;
      width: 220px;
      left: 24px;
      top: -5px;
      pointer-events: none;
      line-height: 1.4;
    }

    .tooltip::after {
      content: "";
      position: absolute;
      top: 10px;
      right: 100%;
      border-width: 5px;
      border-style: solid;
      border-color: transparent #1A202C transparent transparent;
    }

    .tooltip-icon:hover .tooltip {
      visibility: visible;
      opacity: 1;
    }

    .score-bar-container {
      flex: 1;
      background-color: #e9ecef;
      height: 8px;
      border-radius: 4px;
      overflow: hidden;
    }

    .score-bar {
      height: 100%;
      border-radius: 4px;
      background: linear-gradient(90deg, #4361ee, #3a0ca3);
    }

    .score-value {
      margin-left: 10px;
      font-weight: 700;
      color: var(--primary);
    }

    .biomarker-summary {
      color: var(--text-primary);
      font-size: 15px;
      line-height: 1.6;
      margin-bottom: 20px;
    }

    .biomarker-link {
      color: var(--primary);
      font-weight: 600;
      text-decoration: none;
      font-size: 14px;
      transition: var(--transition);
      line-height: 1.5;
    }

    .biomarker-link:hover {
      color: var(--secondary);
      text-decoration: underline;
    }

    .result-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .result-title {
      font-weight: 700;
      font-size: 18px;
      color: var(--text-primary);
    }

    .result-count {
      background-color: var(--primary);
      color: white;
      font-size: 14px;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 20px;
    }

    .footer {
      text-align: center;
      padding: 20px 0;
      color: var(--text-secondary);
      font-size: 13px;
      margin-top: 40px;
      background: linear-gradient(135deg, #f8f9fa, #ffffff);
    }

    .background-blob {
      position: absolute;
      background: radial-gradient(circle, rgba(76, 201, 240, 0.3) 0%, rgba(67, 97, 238, 0) 70%);
      border-radius: 50%;
      z-index: 1;
    }

    .blob-1 {
      width: 300px;
      height: 300px;
      top: -150px;
      right: -100px;
    }

    .blob-2 {
      width: 400px;
      height: 400px;
      top: 50px;
      left: -200px;
      opacity: 0.6;
    }

    .card-blob {
      position: absolute;
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(67, 97, 238, 0.07) 0%, rgba(67, 97, 238, 0) 70%);
      z-index: 0;
      bottom: -20px;
      right: -20px;
    }

    .empty-state {
      text-align: center;
      padding: 30px;
      background-color: var(--bg-card);
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
    }

    .empty-icon {
      font-size: 60px;
      color: #d1d9e6;
      margin-bottom: 20px;
      animation: rotateIcon 3s infinite;
    }

    @keyframes rotateIcon {

      0%,
      100% {
        transform: rotate(0deg);
      }

      50% {
        transform: rotate(10deg);
      }
    }

    .empty-title {
      color: var(--text-primary);
      font-weight: 700;
      margin-bottom: 10px;
    }

    .empty-message {
      color: var(--text-secondary);
      margin-bottom: 30px;
    }

    @media (max-width: 768px) {
      .input-group {
        flex-direction: column;
      }

      .biomarker-grid {
        grid-template-columns: 1fr;
      }

      .app-title {
        font-size: 28px;
      }

      .progress-container {
        padding: 16px;
      }

      .progress-text {
        font-size: 13px;
      }

      .progress-spinner {
        width: 18px;
        height: 18px;
      }

      .voice-selector {
        width: 100%;
        min-width: auto;
      }
    }

    @media (max-width: 480px) {
      .progress-container {
        padding: 12px;
      }

      .progress-text {
        font-size: 12px;
      }

      .progress-spinner {
        width: 16px;
        height: 16px;
      }
    }

    /* Animations */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .fade-in {
      animation: fadeIn 0.5s ease forwards;
    }

    .delay-1 {
      animation-delay: 0.1s;
    }

    .delay-2 {
      animation-delay: 0.2s;
    }

    .delay-3 {
      animation-delay: 0.3s;
    }

    .delay-4 {
      animation-delay: 0.4s;
    }

    .delay-5 {
      animation-delay: 0.5s;
    }

    .autocomplete-suggestions {
      position: absolute;
      border: 1px solid #ddd;
      border-top: none;
      z-index: 99;
      top: 100%;
      left: 0;
      right: 0;
      background-color: white;
      border-radius: 0 0 var(--border-radius) var(--border-radius);
      box-shadow: 0 8px 16px rgba(0,0,0,0.1);
      max-height: 300px;
      overflow-y: auto;
    }

    .suggestion-item {
      padding: 12px 20px;
      cursor: pointer;
      font-size: 15px;
    }

    .suggestion-item:hover {
      background-color: #f1f1f1;
    }

    /* @risg99 - Start of Export buttons styling */
    .export-buttons {
      display: flex;
      gap: 15px;
      margin: 10px 0 20px 0;
    }

    .export-btn {
      background: var(--primary-gradient);
      color: white;
      border: none;
      border-radius: 10px;
      padding: 10px 16px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 10px rgba(67, 97, 238, 0.15);
    }

    .export-btn:hover {
      background: linear-gradient(135deg, #3a0ca3, #4361ee);
    }
    /* @risg99 - End of Export buttons styling */

    /* @risg99 - Start of styling of tooltip */
    .cy-tooltip {
      background-color: #2d2d2d;
      z-index:5000; /*testing for tooltip view wrt canvas*/
      color: #fff;
      border: 1px solid #444;
      font-family: 'Segoe UI', Tahoma, sans-serif;
      font-size: 14px;
      padding: 10px;
      border-radius: 8px;
      max-width: 240px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
      z-index: 9999;
      pointer-events: none;
    }
    /* @risg99 - End of styling of tooltip */

    /* @risg99 - Start of styling for graph legend */
    .graph-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      margin-top: 10px;
      font-family: 'Roboto', sans-serif;
      font-size: 14px;
      color: #333;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .legend-color {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      display: inline-block;
    }

    .legend-color.disease {
      background-color: #4361ee;
    }

    .legend-color.predictive {
      background-color: #06d6a0;
    }

    .legend-color.prognostic {
      background-color: #ffd166;
    }

    .legend-color.diagnostic {
      background-color: #ef476f;
    }

    .legend-color.drug {
      background-color: #ff69b4;
    }

    .graph-controls {
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      gap: 40px;
      margin-bottom: 10px;
    }
    /* @risg99 - End of styling for graph legend */
  </style>
</head>

<body>
  <div class="app-wrapper">
    <header class="header">
      <div class="background-blob blob-1"></div>
      <div class="background-blob blob-2"></div>
      <div class="container">
        <div class="header-content">
          <h1 class="app-title">
            <span class="icon"><i class="fas fa-dna"></i></span>
            BiomarkerFinder
          </h1>
          <p class="app-description">
            Discover and explore the most relevant biomarkers for any disease - understand what they mean for diagnosis,
            prognosis, and targeted treatments.
          </p>
        </div>
      </div>
    </header>
    <div class="container">
      <div class="search-container fade-in">
        <div class="input-group">
          <div class="input-container">
            <input id="diseaseInput" type="text"
              placeholder="Type or speak a disease name or question..." autocomplete="off">
            <div id="autocomplete-list" class="autocomplete-suggestions"></div>
            <i class="input-icon fas fa-search"></i>
            <button id="micBtn" class="mic-btn" title="Use voice input">
              <i class="fas fa-microphone"></i>
            </button>
          </div>
          <select id="voiceSelector" class="voice-selector" title="Choose AI voice">
            <option value="21m00Tcm4TlvDq8ikWAM">Rachel (Warm Female)</option>
            <option value="pNInz6obpgDQGcFmaJgB">Adam (Deep Male)</option>
            <option value="EXAVITQu4vr4xnSDxMaL">Bella (Clear Female)</option>
            <option value="N2lVS1w4EtoT3dr4eOWO">Callum (British Male)</option>
          </select>
          <button id="getBiomarkersBtn">
            <span id="buttonText">Find Biomarkers</span>
            <span id="loadingSpinner" style="display: none;"><span class="loading-spinner"></span></span>
          </button>
        </div>
        <div class="recent-searches">
          <div class="recent-search-tag">Mantle cell lymphoma</div>
          <div class="recent-search-tag">Non-small cell lung cancer</div>
          <div class="recent-search-tag">Breast cancer</div>
          <div class="recent-search-tag">Colorectal cancer</div>
          <div class="recent-search-tag">Acute myeloid leukemia</div>
        </div>
      </div>

      <!-- Progress Indicator -->
      <div id="progressContainer" class="progress-container">
        <div class="progress-bar">
          <div id="progressFill" class="progress-fill"></div>
        </div>
        <div class="progress-steps">
          <div class="progress-spinner"></div>
          <div id="progressText" class="progress-text">Processing your request...</div>
        </div>
      </div>

      <div class="output-container">
        <div id="output" class="biomarker-results">
          <div class="empty-state">
            <div class="empty-icon"><i class="fas fa-dna"></i></div>
            <h3 class="empty-title">Search for biomarkers</h3>
            <p class="empty-message">Enter a cancer type or disease name above to discover relevant biomarkers</p>
          </div>
        </div>

        <!-- @risg99 - Start of toggle button container -->
        <div style="margin-top: 20px;">
          <button id="toggleViewBtn" style="
              background: var(--accent);
              color: white;
              border: none;
              border-radius: var(--border-radius);
              padding: 12px 18px;
              font-size: 14px;
              font-weight: bold;
              cursor: pointer;
              margin-bottom: 15px;
              display: none;
            ">
            Toggle to Visual Mode
          </button>
        </div>

        <div class="graph-controls" style="display: none" id="visualControls">
          <div id="graphLegend" class="graph-legend">
            <span class="legend-item">
              <span class="legend-color disease"></span> Disease
            </span>
            <span class="legend-item">
              <span class="legend-color predictive"></span> Biomarker - Predictive
            </span>
            <span class="legend-item">
              <span class="legend-color prognostic"></span> Biomarker - Prognostic
            </span>
            <span class="legend-item">
              <span class="legend-color diagnostic"></span> Biomarker - Diagnostic
            </span>
            <span class="legend-item">
              <span class="legend-color drug"></span> Drug
            </span>
          </div>
        </div>

        <div id="cy"
          style="display: none; width: 100%; height: 600px; border-radius: var(--border-radius); box-shadow: var(--card-shadow); background-color: white; margin-top: 20px;">
        </div>
        <!-- @risg99 - End of toggle button container -->

      </div>
    </div>
  </div>
  <script>
    // DOM element references
    const input = document.getElementById("diseaseInput");
    const output = document.getElementById("output");
    const btn = document.getElementById("getBiomarkersBtn");
    const buttonText = document.getElementById("buttonText");
    const loadingSpinner = document.getElementById("loadingSpinner");
    const recentSearchTags = document.querySelectorAll(".recent-search-tag");
    const autocompleteList = document.getElementById("autocomplete-list");
    const micBtn = document.getElementById("micBtn");
    const voiceSelector = document.getElementById("voiceSelector");

    // Voice recognition setup
    let recognition;
    let selectedVoiceId = "21m00Tcm4TlvDq8ikWAM"; // Default: Rachel

    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.lang = 'en-US';

      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        input.value = transcript;
        micBtn.classList.remove('listening');
        // Automatically trigger search with voice input
        searchBiomarkers(transcript);
      };

      recognition.onerror = (event) => {
        console.error('Speech recognition error:', event.error);
        micBtn.classList.remove('listening');

        let errorMessage = 'Voice input error. ';
        if (event.error === 'no-speech') {
          errorMessage += 'No speech detected. Please try again.';
        } else if (event.error === 'not-allowed') {
          errorMessage += 'Microphone access denied. Please enable it in your browser settings.';
        } else {
          errorMessage += 'Please try typing instead.';
        }
        alert(errorMessage);
      };

      recognition.onend = () => {
        micBtn.classList.remove('listening');
      };
    }

    // Mic button click handler
    if (micBtn) {
      micBtn.addEventListener('click', () => {
        if (recognition) {
          if (micBtn.classList.contains('listening')) {
            // Stop listening if already active
            recognition.stop();
            micBtn.classList.remove('listening');
          } else {
            // Start listening
            micBtn.classList.add('listening');
            try {
              recognition.start();
            } catch (error) {
              console.error('Error starting recognition:', error);
              micBtn.classList.remove('listening');
            }
          }
        } else {
          alert('Speech recognition is not supported in your browser. Please use Chrome, Edge, or Safari.');
        }
      });
    }

    // Voice selector change handler
    if (voiceSelector) {
      voiceSelector.addEventListener('change', (e) => {
        selectedVoiceId = e.target.value;
        console.log('Selected voice:', selectedVoiceId);
      });
    }

    // @risg99 - Start of Toggle button and Cytoscape references
    const toggleBtn = document.getElementById("toggleViewBtn");
    const cyContainer = document.getElementById("cy");
    const visualControls = document.getElementById("visualControls");
    // @risg99 - End of Toggle button and Cytoscape references

    let diseaseNames = [];

    // @risg99 - Start of Prefill functionality call
    window.addEventListener("DOMContentLoaded", async () => {
      const params = new URLSearchParams(window.location.search);
      const disease = params.get("disease");
      if (disease) {
        const decodedDisease = decodeURIComponent(disease);
        input.value = decodedDisease;
        await searchBiomarkers(decodedDisease); // run search automatically
      }
    });
    // @risg99 - End of Prefill functionality call

    // Fetch and process the disease list
    async function fetchDiseases() {
      try {
        const response = await fetch('../data/combined_diseases.json');
        const data = await response.json();
        diseaseNames = data.data.search.hits.map(hit => hit.object.name);
      } catch (error) {
        console.error("Failed to load disease list:", error);
      }
    }

    // Display autocomplete suggestions
    function displaySuggestions(matches) {
      if (matches.length > 0) {
        const html = matches.map(match => `<div class="suggestion-item">${match}</div>`).join('');
        autocompleteList.innerHTML = html;
        autocompleteList.style.display = 'block';
      } else {
        autocompleteList.style.display = 'none';
      }
    }

    // Event listener for input
    input.addEventListener("input", () => {
      const value = input.value.toLowerCase();
      if (!value) {
        autocompleteList.style.display = 'none';
        return;
      }
      const matches = diseaseNames.filter(disease => disease.toLowerCase().includes(value)).slice(0, 10);
      displaySuggestions(matches);
    });

    // Event listener for clicking on a suggestion
    autocompleteList.addEventListener("click", (e) => {
      if (e.target.classList.contains("suggestion-item")) {
        input.value = e.target.textContent;
        autocompleteList.style.display = 'none';
      }
    });

    // Close autocomplete when clicking elsewhere
    document.addEventListener("click", (e) => {
      if (e.target.id !== 'diseaseInput') {
        autocompleteList.style.display = 'none';
      }
    });

    // @risg99 - Start of Updated Click event for recent search tags to reuse same function with prefill
    recentSearchTags.forEach(tag => {
      tag.addEventListener("click", () => {
        const diseaseName = tag.textContent;
        input.value = diseaseName;
        searchBiomarkers(diseaseName);
      });
    });
    // @risg99 - End of Updated Click event for recent search tags to reuse same function with prefill

    // Enter key event for search input
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        if (autocompleteList.style.display === 'block') {
          autocompleteList.style.display = 'none';
        } else {
          searchBiomarkers();
        }
      }
    });

    // Click event for search button
    btn.addEventListener("click", searchBiomarkers);

    // @risg99 - Start of Toggle button event listener
    toggleBtn.addEventListener("click", () => {
      const isVisual = cyContainer.style.display === "block";
      if (isVisual) {
        cyContainer.style.display = "none";
        output.style.display = "block";
        toggleBtn.textContent = "Toggle to Visual Mode";
        visualControls.style.display = "none";
      } else {
        cyContainer.style.display = "block";
        output.style.display = "none";
        toggleBtn.textContent = "Toggle to List Mode";
        visualControls.style.display = "flex";
      }
    });
    // @risg99 - End of Toggle button event listener

    // @risg99 - Start of function definition to fetch all drugs for a disease using pagination
    async function fetchAllDrugsForDisease(efoId) {
      let allDrugs = [];
      let cursor = null;

      do {
        const query = `
          query getDrugsForBiomarkerDisease($efoId: String!, $cursor: String) {
            disease(efoId: $efoId) {
              knownDrugs(size: 1000, cursor: $cursor) {
                cursor
                rows {
                  drug {
                    id
                    name
                  }
                  target {
                    approvedSymbol
                    id
                  }
                  status
                  phase
                }
              }
            }
          }
        `;

        const response = await fetch("https://api.platform.opentargets.org/api/v4/graphql", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            query,
            variables: { efoId, cursor },
          }),
        });

        const result = await response.json();
        const drugsPage = result?.data?.disease?.knownDrugs;
        if (!drugsPage) break;

        allDrugs.push(...drugsPage.rows);
        cursor = drugsPage.cursor;

      } while (cursor);

      return allDrugs;
    }

    async function fetchDiseaseEfoId(diseaseName) {
      const query = `
        query Search($term: String!) {
          search(queryString: $term, entityNames: ["disease"]) {
            hits {
              id
              name
              entity
            }
          }
        }
      `;

      const variables = { term: diseaseName };

      const response = await fetch("https://api.platform.opentargets.org/api/v4/graphql", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          query,
          variables,
        }),
      });

      const efoRes = await response.json();
      const match = efoRes?.data?.search?.hits.find(
        (item) => item.entity === "disease"
      );

      if (!match || !match.id) {
        console.warn("‚ö†Ô∏è No matching EFO ID found for:", diseaseName);
        return null;
      }

      const efoId = match.id;
      return efoId;
    }
    // @risg99 - End of function definition to fetch all drugs for a disease using pagination

    // Progress indicator helper functions
    function showProgress(percentage, message) {
      const progressContainer = document.getElementById('progressContainer');
      const progressFill = document.getElementById('progressFill');
      const progressText = document.getElementById('progressText');

      progressContainer.classList.add('show');
      progressFill.style.width = percentage + '%';
      progressText.textContent = message;
    }

    function hideProgress() {
      const progressContainer = document.getElementById('progressContainer');
      progressContainer.classList.remove('show');
    }

    // @risg99 - Start of Prefill functionality
    async function searchBiomarkers(prefilledDisease) {
      autocompleteList.style.display = 'none';
      const diseaseName = prefilledDisease || input.value.trim();
      if (!diseaseName) {
        output.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon"><i class="fas fa-search"></i></div>
            <h3 class="empty-title">Please enter a disease name</h3>
            <p class="empty-message">Try searching for conditions like "breast cancer", "multiple myeloma", or "NSCLC"</p>
          </div>
        `;
        return;
      }

      buttonText.style.display = "none";
      loadingSpinner.innerHTML = '<span class="loading-spinner"></span>';
      loadingSpinner.style.display = "inline";
      output.innerHTML = "";

      // Show initial progress
      showProgress(20, 'Looking up disease...');

      try {
        // @risg99 - Start of call to fetchDiseaseEfoId
        const efoId = await fetchDiseaseEfoId(diseaseName);

        if (!efoId) {
          output.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon"><i class="fas fa-exclamation-circle"></i></div>
              <h3 class="empty-title">Disease not found</h3>
              <p class="empty-message">Please check your spelling or try a different disease name.</p>
            </div>
          `;
          buttonText.style.display = "inline";
          loadingSpinner.style.display = "none";
          hideProgress();
          return;
        }
        // @risg99 - End of call to fetchDiseaseEfoId

        // Update progress
        showProgress(40, 'Fetching biomarkers from Open Targets...');

        // Fetch biomarkers from API
        const response = await fetch("https://us-central1-biomarker-matchmaker.cloudfunctions.net/getBiomarkers", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ disease: diseaseName })
        });
        const data = await response.json();

        if (data.error) {
          output.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon"><i class="fas fa-exclamation-circle"></i></div>
              <h3 class="empty-title">Error</h3>
              <p class="empty-message">${data.error}</p>
            </div>
          `;
          buttonText.style.display = "inline";
          loadingSpinner.style.display = "none";
          hideProgress();
          return;
        }

        // Update progress
        showProgress(60, 'Analyzing biomarker data...');

        // @risg99 - Start of function definition & calls to match drugs to biomarkers
        function matchDrugsToBiomarkers(drugs, biomarkers) {
          const matched = [];

          drugs.forEach((row, i) => {
            const { drug, target, status, phase } = row;
            if (!drug || !target) return;

            const matchIndex = biomarkers.findIndex(b =>
              b.geneName?.toLowerCase() === target.approvedSymbol?.toLowerCase() ||
              (b.openTargetsLink && b.openTargetsLink.includes(target.id))
            );

            if (matchIndex === -1) return;

            matched.push({
              drug,
              target,
              matchedBiomarkerIndex: matchIndex,
              status,
              phase
            });
          });

          return matched;
        }

        const allDrugs = await fetchAllDrugsForDisease(efoId);

        // Remove duplicate drug-target pairs
        const uniqueDrugs = [];
        const seen = new Set();

        for (let row of allDrugs) {
          const key = `${row.drug.id}_${row.target.id}`;
          if (!seen.has(key)) {
            seen.add(key);
            uniqueDrugs.push(row);
          }
        }
        const matchedDrugs = matchDrugsToBiomarkers(uniqueDrugs, data.biomarkers);
        console.log("üíä Matched drugs:", matchedDrugs);
        // @risg99 - End of function definition & calls to match drugs to biomarkers

        // Update progress
        showProgress(80, 'Generating AI explanations...');

        // Create card for each biomarker
        const biomarkerList = data.biomarkers.map(b => `
          <div class="biomarker-card fade-in">
            <div class="card-blob"></div>
            <div class="biomarker-type">
              Classifying...
            </div>
            <h3 class="biomarker-name">${b.name}</h3>
            <div class="biomarker-gene">${b.geneName}</div>
            <div class="biomarker-score">
              <span class="score-label">Score
                <span class="tooltip-icon">?
                  <span class="tooltip">This score (0‚Äì1) reflects how strongly the biomarker is associated with the disease, based on evidence from Open Targets. A higher score means a stronger association.</span>
                </span>
              </span>
              <div class="score-bar-container">
                <div class="score-bar" style="width: ${Math.round(b.score * 100)}%"></div>
              </div>
              <span class="score-value">${parseFloat(b.score).toFixed(2)}</span>
            </div>
            <p class="biomarker-summary">${b.summary}</p>
            <a href="${b.openTargetsLink}" target="_blank" class="biomarker-link">
              View on Open Targets
            </a>
          </div>
        `).join("");

        // @risg99 - Start of Export buttons added
        let resultsHTML = `
          <div class="result-header fade-in">
            <h2 class="result-title">Top biomarkers for ${data.disease}</h2>
          </div>
          <div class="export-buttons">
            <button id="exportCSV" class="export-btn"><i class="fas fa-file-csv"></i> Export to CSV</button>
            <button id="exportPDF" class="export-btn"><i class="fas fa-file-pdf"></i> Download PDF Summary</button>
          </div>
          <div class="biomarker-grid">
            ${biomarkerList}
          </div>
        `;
        // @risg99 - End of Export buttons added

        // Final progress update
        showProgress(100, 'Complete!');

        output.innerHTML = resultsHTML;

        const typeSpans = document.querySelectorAll(".biomarker-type");

        // Use classification data already returned from backend (no additional API calls needed)
        const classifications = data.biomarkers.map((biomarker, i) => {
          const type = biomarker.type || biomarker.category || "unknown";
          const typeText = type.toLowerCase();

          let typeClass = "";
          if (typeText.includes("predictive")) {
            typeClass = "predictive";
          } else if (typeText.includes("prognostic")) {
            typeClass = "prognostic";
          } else if (typeText.includes("diagnostic")) {
            typeClass = "diagnostic";
          }

          // Update UI with classification
          const formattedType = type.charAt(0).toUpperCase() + type.slice(1).toLowerCase();
          typeSpans[i].textContent = formattedType;
          if (typeClass) typeSpans[i].classList.add(typeClass);

          return typeClass || "unknown";
        });

        // Build graph with biomarkers, disease, and drugs
        buildGraph(data, classifications, matchedDrugs);

        // @risg99 - Start of Export to CSV and PDF functionality
        setTimeout(() => {
          document.getElementById("exportCSV").addEventListener("click", () => {
            const cards = document.querySelectorAll(".biomarker-card");
            const csvRows = [];

            const date = new Date().toISOString().split("T")[0];
            csvRows.push(`BiomarkerFinder Summary Report`);
            csvRows.push(`Disease: ${data.disease}`);
            csvRows.push(`Date: ${date}`);
            csvRows.push(`Evidence Source: Open Targets`);
            csvRows.push("");

            const headers = ["#", "Biomarker", "Gene", "Score", "Type", "Summary", "Evidence Source"];
            csvRows.push(headers.join(","));

            function quoteCSV(value) {
              if (value === null || value === undefined) return "";
              const safeValue = value.replace(/"/g, '""');
              return `"${safeValue}"`;
            }

            cards.forEach((card, i) => {
              const name = card.querySelector(".biomarker-name").textContent.trim();
              const gene = card.querySelector(".biomarker-gene").textContent.trim();
              const score = card.querySelector(".score-value").textContent.trim();
              const type = card.querySelector(".biomarker-type").textContent.trim();
              const summary = card.querySelector(".biomarker-summary").textContent.trim();
              const link = card.querySelector(".biomarker-link").href.trim();

              const row = [
                i + 1,
                quoteCSV(name),
                quoteCSV(gene),
                quoteCSV(score),
                quoteCSV(type),
                quoteCSV(summary),
                quoteCSV(link)
              ].join(",");
              csvRows.push(row);
            });

            const csvContent = "\uFEFF" + csvRows.join("\n");

            const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `${data.disease.replace(/\s+/g, "_")}_biomarkers_${date}.csv`;
            a.click();
            URL.revokeObjectURL(url);
          });

          document.getElementById("exportPDF").addEventListener("click", async () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: "p", unit: "mm", format: "a4" });

            const date = new Date().toLocaleDateString();
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const marginX = 14;
            let y = 30;
            const lineHeight = 7;

            doc.setFillColor(220, 230, 255);
            doc.rect(0, 0, pageWidth, 20, "F");
            doc.setTextColor(30, 30, 100);
            doc.setFont("helvetica", "bold");
            doc.setFontSize(18);
            doc.text("BiomarkerFinder Summary Report", marginX, 13);

            doc.setTextColor(0, 0, 0);
            doc.setFont("helvetica", "normal");
            doc.setFontSize(12);
            doc.text(`Disease: ${data.disease}`, marginX, y);
            doc.text(`Date: ${date}`, marginX, y + 6);
            doc.text("Evidence Source: Open Targets", marginX, y + 12);
            y += 22;

            doc.setDrawColor(180);
            doc.line(marginX, y, pageWidth - marginX, y);
            y += 8;

            const cards = document.querySelectorAll(".biomarker-card");
            let pageNumber = 1;

            function checkPageSpace(extraSpace = 0) {
              if (y + extraSpace > pageHeight - 20) {
                doc.setFontSize(10);
                doc.setTextColor(150);
                doc.text(`Page ${pageNumber}`, pageWidth / 2, pageHeight - 10, { align: "center" });
                doc.addPage();
                pageNumber++;
                y = 20;
                doc.setFont("helvetica", "bold");
                doc.setFontSize(14);
                doc.setTextColor(30, 30, 100);
                doc.text("BiomarkerFinder Summary (continued)", marginX, y);
                y += 10;
                doc.setDrawColor(200);
                doc.line(marginX, y, pageWidth - marginX, y);
                y += 8;
                doc.setFont("helvetica", "normal");
                doc.setTextColor(0, 0, 0);
              }
            }

            cards.forEach((card, index) => {
              const name = card.querySelector(".biomarker-name").textContent;
              const gene = card.querySelector(".biomarker-gene").textContent || "N/A";
              const score = card.querySelector(".score-value").textContent || "N/A";
              const type = card.querySelector(".biomarker-type").textContent || "Unclassified";
              const summary = card.querySelector(".biomarker-summary").textContent || "";
              const link = card.querySelector(".biomarker-link").href;

              checkPageSpace(40);

              doc.setFont("helvetica", "bold");
              doc.setFontSize(14);
              doc.setTextColor(30, 30, 100);
              doc.text(`${index + 1}. ${name}`, marginX, y);
              y += lineHeight;

              doc.setFont("helvetica", "normal");
              doc.setFontSize(12);
              doc.setTextColor(0, 0, 0);
              doc.text(`‚Ä¢ Gene: ${gene}`, marginX + 4, y);
              y += lineHeight;
              doc.text(`‚Ä¢ Score: ${score}`, marginX + 4, y);
              y += lineHeight;
              doc.text(`‚Ä¢ Type: ${type}`, marginX + 4, y);
              y += lineHeight;

              const summaryLines = doc.splitTextToSize(`‚Ä¢ Summary: ${summary}`, pageWidth - marginX * 2);
              checkPageSpace(summaryLines.length * 6);
              doc.text(summaryLines, marginX + 4, y);
              y += summaryLines.length * 6;

              doc.setTextColor(0, 0, 180);
              const urlLines = doc.splitTextToSize(`‚Ä¢ Evidence Source: ${link}`, pageWidth - marginX * 2);
              doc.text(urlLines, marginX + 4, y);
              doc.setTextColor(0, 0, 0);
              y += urlLines.length * 6 + 6;

              doc.setDrawColor(230);
              doc.line(marginX, y, pageWidth - marginX, y);
              y += 6;
            });

            doc.setFontSize(10);
            doc.setTextColor(150);
            doc.text(`Page ${pageNumber}`, pageWidth / 2, pageHeight - 10, { align: "center" });

            doc.save(`${data.disease.replace(/\s+/g, "_")}_biomarkers_summary.pdf`);
          });
        }, 700);
        // @risg99 - End of Export to CSV and PDF functionality

      } catch (err) {
        console.error(err);
        output.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon"><i class="fas fa-exclamation-circle"></i></div>
            <h3 class="empty-title">Something went wrong</h3>
            <p class="empty-message">Please try again later.</p>
          </div>
        `;
      } finally {
        buttonText.style.display = "inline";
        loadingSpinner.style.display = "none";

        // Hide progress after a brief delay to show "Complete!" message
        setTimeout(() => hideProgress(), 800);
      }
    }

    // @risg99 - Start of building graph function definition
    function buildGraph(data, classifications = [], drugRows = []) {
      toggleBtn.style.display = "inline-block";
      const nodes = [];
      const edges = [];

      nodes.push({ data: { id: "disease", label: data.disease, type: "disease", tooltip: data.disease } });

      data.biomarkers.forEach((b, idx) => {
        const biId = `b_${idx}`;
        nodes.push({
          data: {
            id: biId,
            label: b.name,
            type: (classifications[idx] || "unknown").toLowerCase(),
            tooltip: b.summary
          }
        });
        edges.push({ data: { source: biId, target: "disease" } });
      });

      drugRows.forEach((row, i) => {
        const drug = row.drug;
        const target = row.target;
        if (!drug || !target) return;

        const biomIdx = data.biomarkers.findIndex(
          b => b.openTargetsLink.includes(target.id) || b.geneName.toLowerCase() === target.approvedSymbol.toLowerCase()
        );

        const biId = `b_${biomIdx}`;
        const drugId = `drug_${drug.id}_${i}`;

        if (!nodes.some(n => n.data.id === drugId)) {
          nodes.push({
            data: {
              id: drugId,
              label: drug.name,
              type: "drug",
              tooltip: `Status: ${row.status}, Phase: ${row.phase}`
            }
          });
        }

        edges.push({ data: { source: biId, target: drugId } });
      });

      const cy = cytoscape({
        container: cyContainer,
        elements: [...nodes.map(n => ({ data: n.data })), ...edges],

        layout: {
          name: "cose",
          animate: true,
          animationDuration: 1000,
          fit: true,
          padding: 80,
          nodeRepulsion: 4000000,
          idealEdgeLength: 500,
          gravity: 100,
          numIter: 1000,
          initialTemp: 200,
          coolingFactor: 0.95,
          minTemp: 1.0
        },

        style: [
          {
            selector: "node",
            style: {
              label: "data(label)",
              "background-color": ele => {
                const t = ele.data("type");
                switch (t) {
                  case "predictive": return "#06d6a0";
                  case "prognostic": return "#ffd166";
                  case "diagnostic": return "#ef476f";
                  case "disease": return "#4361ee";
                  case "drug": return "#ff69b4";
                  default: return "#adb5bd";
                }
              },
              width: ele => {
                const t = ele.data("type");
                return t === "disease" ? 160 : t === "drug" ? 80 : 70;
              },
              height: ele => {
                const t = ele.data("type");
                return t === "disease" ? 160 : t === "drug" ? 80 : 70;
              },
              "font-size": ele => {
                const t = ele.data("type");
                return t === "disease" ? "24px" : "14px";
              },
              color: "#2b2d42",
              "text-valign": "center",
              "text-halign": "center",
              shape: "ellipse",
              "text-wrap": "wrap",
              "text-max-width": "100px",
              "overlay-padding": "6px",
              "z-index": 10
            }
          },
          {
            selector: "edge",
            style: {
              width: 3,
              "line-color": "#bcbcbc",
              "curve-style": "unbundled-bezier",
              "target-arrow-shape": "triangle",
              "target-arrow-color": "#bcbcbc",
              "arrow-scale": 1.5,
              "opacity": 0.7
            }
          },
          {
            selector: ":selected",
            style: {
              "background-color": "#ffb703",
              "line-color": "#fb8500",
              "target-arrow-color": "#fb8500",
              "source-arrow-color": "#fb8500",
              "border-width": 2,
              "border-color": "#ffb703"
            }
          }
        ]
      });

      cy.nodes().forEach(node => {
        node.on('mouseover', () => {
          const tooltip = document.createElement('div');
          tooltip.className = 'cy-tooltip';
          tooltip.textContent = node.data('tooltip');
          document.body.appendChild(tooltip);
          tooltip.style.position = 'absolute';
          tooltip.style.left = `${event.pageX + 10}px`;
          tooltip.style.top = `${event.pageY + 10}px`;
        });

        node.on('mouseout', () => {
          const existing = document.querySelector('.cy-tooltip');
          if (existing) existing.remove();
        });
      });

      cy.ready(() => {
        cy.layout({ name: 'cose', animate: true }).run();
        setTimeout(() => {
          cy.fit();
        }, 500);
      });
    }
    // @risg99 - End of building graph function definition

    window.addEventListener('load', () => {
      input.value = "";
      fetchDiseases();
    });
  </script>
</body>

</html>
