<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BiomarkerFinder</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    :root {
      --primary: #4361ee;
      --primary-gradient: linear-gradient(135deg, #4361ee, #3a0ca3 70%);
      --secondary: #7209b7;
      --accent: #4cc9f0;
      --text-primary: #2b2d42;
      --text-secondary: #6c757d;
      --bg-primary: #ffffff;
      --bg-secondary: #f8f9fa;
      --bg-card: #ffffff;
      --success: #06d6a0;
      --warning: #ffd166;
      --danger: #ef476f;
      --border-radius: 12px;
      --card-shadow: 0 10px 20px rgba(67, 97, 238, 0.07), 0 6px 6px rgba(67, 97, 238, 0.06);
      --header-height: 120px;
      --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; }
    body { background-color: var(--bg-secondary); color: var(--text-primary); min-height: 100vh; line-height: 1.7; overflow-x: hidden; }
    .container { width: 100%; max-width: 1080px; margin: 0 auto; padding: 0 30px; }
    .app-wrapper { position: relative; }
    .header { height: var(--header-height); background: var(--primary-gradient); position: relative; padding-top: 30px; padding-bottom: 40px; overflow: hidden; }
    .header-content { position: relative; z-index: 2; opacity: 0; transform: translateY(20px); animation: fadeInHeader 1s ease forwards; }
    @keyframes fadeInHeader { to { opacity: 1; transform: translateY(0); } }
    .app-title { display: flex; align-items: center; color: white; font-weight: 700; font-size: 28px; margin-bottom: 15px; letter-spacing: -0.5px; }
    .app-title .icon { margin-right: 12px; font-size: 26px; background: rgba(255,255,255,0.2); width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; border-radius: 10px; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); box-shadow: 0 0 15px rgba(67,97,238,0.3); }
    .app-description { color: rgba(255,255,255,0.9); font-size: 16px; margin-bottom: 20px; max-width: 600px; line-height: 1.5; }
    .search-container { position: relative; z-index: 3; background-color: var(--bg-card); border-radius: var(--border-radius); box-shadow: var(--card-shadow); padding: 20px; margin-top: -40px; }
    .input-group { display: flex; gap: 15px; align-items: center; }
    .input-container { position: relative; flex: 1; }
    #diseaseInput { width: 100%; padding: 16px 45px 16px 20px; font-size: 16px; border: 2px solid #e9ecef; border-radius: 20px; background-color: var(--bg-secondary); transition: border-color 0.3s, box-shadow 0.3s; outline: none; }
    #diseaseInput:focus { border-color: var(--accent); box-shadow: 0 0 0 4px rgba(76, 201, 240, 0.2); }
    .input-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); pointer-events: none; transition: var(--transition); }
    #diseaseInput:focus + .input-icon { color: var(--accent); }
    #getBiomarkersBtn { background: var(--primary-gradient); color: white; border: none; border-radius: var(--border-radius); padding: 16px 24px; font-size: 16px; font-weight: 600; cursor: pointer; transition: var(--transition); box-shadow: 0 4px 12px rgba(67, 97, 238, 0.2); display: flex; align-items: center; gap: 10px; white-space: nowrap; }
    #getBiomarkersBtn:hover { background: linear-gradient(135deg, #3a0ca3, #4361ee); }
    #getBiomarkersBtn:active { transform: translateY(0); }
    .loading-spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255, 255, 255, 0.3); border-top: 3px solid white; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .recent-searches { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
    .recent-search-tag { background-color: rgba(67, 97, 238, 0.1); color: var(--primary); padding: 6px 12px; border-radius: 20px; font-size: 13px; cursor: pointer; transition: transform 0.3s, box-shadow 0.3s; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); }
    .recent-search-tag:hover { transform: translateY(-2px); box-shadow: 0 6px 10px rgba(0, 0, 0, 0.1); }
    .output-container { padding: 20px 0; }
    .biomarker-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; margin-top: 20px; }
    .biomarker-card { background-color: var(--bg-card); border-radius: var(--border-radius); padding: 30px; box-shadow: var(--card-shadow); transition: var(--transition); position: relative; overflow: hidden; background: linear-gradient(135deg, #ffffff, #f8f9fa); }
    .biomarker-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(67, 97, 238, 0.1), 0 10px 10px rgba(67, 97, 238, 0.05); }
    .biomarker-type { display: inline-block; background-color: #EDF2F7; color: #4A5568; font-weight: 600; padding: 6px 12px; border-radius: 20px; font-size: 13px; margin-bottom: 15px; text-transform: capitalize; }
    .biomarker-type.predictive { background-color: #E6FFFA; color: #047857; }
    .biomarker-type.prognostic { background-color: #FEF3C7; color: #B45309; }
    .biomarker-type.diagnostic { background-color: #FEE2E2; color: #B91C1C; }
    .biomarker-type .icon { margin-right: 5px; }
    .biomarker-name { font-size: 24px; font-weight: 700; margin-bottom: 5px; color: var(--text-primary); letter-spacing: -0.5px; }
    .biomarker-gene { color: var(--text-secondary); font-size: 15px; margin-bottom: 15px; }
    .biomarker-score { position: relative; display: flex; align-items: center; margin: 8px 0; }
    .score-label { font-weight: 600; font-size: 15px; margin-right: 10px; display: flex; align-items: center; }
    .tooltip-icon { display: inline-block; width: 16px; height: 16px; background-color: #E2E8F0; color: #4A5568; border-radius: 50%; text-align: center; line-height: 16px; font-size: 12px; margin-left: 5px; cursor: help; position: relative; font-weight: 700; }
    .tooltip { visibility: hidden; position: absolute; background-color: #1A202C; color: white; text-align: left; padding: 10px 12px; border-radius: 6px; z-index: 1; opacity: 0; transition: opacity 0.3s; font-weight: normal; font-size: 12px; width: 220px; left: 24px; top: -5px; pointer-events: none; line-height: 1.4; }
    .tooltip::after { content: ""; position: absolute; top: 10px; right: 100%; border-width: 5px; border-style: solid; border-color: transparent #1A202C transparent transparent; }
    .tooltip-icon:hover .tooltip { visibility: visible; opacity: 1; }
    .score-bar-container { flex: 1; background-color: #e9ecef; height: 8px; border-radius: 4px; overflow: hidden; }
    .score-bar { height: 100%; border-radius: 4px; background: linear-gradient(90deg, #4361ee, #3a0ca3); }
    .score-value { margin-left: 10px; font-weight: 700; color: var(--primary); }
    .biomarker-summary { color: var(--text-primary); font-size: 15px; line-height: 1.6; margin-bottom: 20px; }

    /* Collapsible blocks */
    .collapsible { border: 1px solid #edf2f7; border-radius: 10px; background: #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.03); margin-top: 10px; }
    .collapsible-header {
      display: flex; align-items: center; justify-content: space-between;
      width: 100%; background: #f7f9fc; border: none; outline: none;
      padding: 10px 14px; font-weight: 700; color: var(--text-primary);
      border-radius: 10px; cursor: pointer; font-size: 15px; /* match summary size */
    }
    .collapsible-header .chev { transition: transform .2s ease; }
    .collapsible-header[aria-expanded="true"] .chev { transform: rotate(180deg); }
    .collapsible-content { display: none; padding: 12px 14px 14px; }
    .collapsible-content.open { display: block; }

    /* Drugs & Repurposing */
    .treatments { margin-top: .4rem; }
    .treatments-list { list-style: none; padding-left: 0; }
    .treatments-list li {
      position: relative;
      padding-left: 2rem;
      margin-bottom: .65rem;
      font-size: 15px;
      color: var(--text-primary);
    }
    .treatments-list li::before {
      content: "üíä";
      position: absolute; left: 0; top: 0.05rem;
      width: 22px; height: 22px; border-radius: 50%;
      background: var(--primary-gradient);
      color: #fff; font-size: 13px;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.12);
    }
    .drug-name { font-weight: 700; color: var(--text-primary); }
    .drug-detail { color: var(--text-primary); }

    .repurpose { margin-top: .6rem; }
    .repurpose-title { font-weight: 700; font-size: 15px; margin-bottom: .35rem; }
    .repurpose-list { list-style: none; padding-left: 0; }
    .repurpose-list li {
      position: relative;
      padding-left: 2rem;
      margin-bottom: .55rem;
      font-size: 15px; color: var(--text-primary);
    }
    .repurpose-list li::before {
      content: "üîÅ";
      position: absolute; left: 0; top: 0.05rem;
      width: 22px; height: 22px; border-radius: 50%;
      background: var(--primary-gradient);
      color: #fff; font-size: 12px;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.12);
    }
    .repurpose-efo { font-size: .9rem; color: #6c757d; margin-left: .35rem; }

    .biomarker-link { color: var(--primary); font-weight: 600; text-decoration: none; font-size: 14px; transition: var(--transition); line-height: 1.5; display:inline-block; margin-top: 28px; } /* extra distance from last toggle */
    .biomarker-link:hover { color: var(--secondary); text-decoration: underline; }
    .result-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .result-title { font-weight: 700; font-size: 18px; color: var(--text-primary); }
    .result-count { background-color: var(--primary); color: white; font-size: 14px; font-weight: 600; padding: 4px 10px; border-radius: 20px; }
    .footer { text-align: center; padding: 20px 0; color: var(--text-secondary); font-size: 13px; margin-top: 40px; background: linear-gradient(135deg, #f8f9fa, #ffffff); }
    .background-blob { position: absolute; background: radial-gradient(circle, rgba(76, 201, 240, 0.3) 0%, rgba(67, 97, 238, 0) 70%); border-radius: 50%; z-index: 1; }
    .blob-1 { width: 300px; height: 300px; top: -150px; right: -100px; }
    .blob-2 { width: 400px; height: 400px; top: 50px; left: -200px; opacity: 0.6; }
    .card-blob { position: absolute; width: 100px; height: 100px; border-radius: 50%; background: radial-gradient(circle, rgba(67, 97, 238, 0.07) 0%, rgba(67, 97, 238, 0) 70%); z-index: 0; bottom: -20px; right: -20px; }
    .empty-state { text-align: center; padding: 30px; background-color: var(--bg-card); border-radius: var(--border-radius); box-shadow: var(--card-shadow); }
    .empty-icon { font-size: 60px; color: #d1d9e6; margin-bottom: 20px; animation: rotateIcon 3s infinite; }
    @keyframes rotateIcon { 0%, 100% { transform: rotate(0deg); } 50% { transform: rotate(10deg); } }
    .empty-title { color: var(--text-primary); font-weight: 700; margin-bottom: 10px; }
    .empty-message { color: var(--text-secondary); margin-bottom: 30px; }
    @media (max-width: 768px) {
      .input-group { flex-direction: column; }
      .biomarker-grid { grid-template-columns: 1fr; }
      .app-title { font-size: 22px; }
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .fade-in { animation: fadeIn 0.5s ease forwards; }
    .delay-1 { animation-delay: 0.1s; }
    .delay-2 { animation-delay: 0.2s; }
    .delay-3 { animation-delay: 0.3s; }
    .delay-4 { animation-delay: 0.4s; }
    .delay-5 { animation-delay: 0.5s; }
    .autocomplete-suggestions { position: absolute; border: 1px solid #ddd; border-top: none; z-index: 99; top: 100%; left: 0; right: 0; background-color: white; border-radius: 0 0 var(--border-radius) var(--border-radius); box-shadow: 0 8px 16px rgba(0,0,0,0.1); max-height: 300px; overflow-y: auto; }
    .suggestion-item { padding: 12px 20px; cursor: pointer; font-size: 15px; }
    .suggestion-item:hover { background-color: #f1f1f1; }
  </style>
</head>
<body>
  <div class="app-wrapper">
    <header class="header">
      <div class="background-blob blob-1"></div>
      <div class="background-blob blob-2"></div>
      <div class="container">
        <div class="header-content">
          <h1 class="app-title">
            <span class="icon"><i class="fas fa-dna"></i></span>
            BiomarkerFinder
          </h1>
          <p class="app-description">
            Discover and explore the most relevant biomarkers for any disease - understand what they mean for diagnosis, prognosis, and targeted treatments.
          </p>
        </div>
      </div>
    </header>
    <div class="container">
      <div class="search-container fade-in">
        <div class="input-group">
          <div class="input-container">
            <input id="diseaseInput" type="text" placeholder="Enter a disease name (e.g., breast cancer, melanoma, leukemia)" autocomplete="off">
            <div id="autocomplete-list" class="autocomplete-suggestions"></div>
            <i class="input-icon fas fa-search"></i>
          </div>
          <button id="getBiomarkersBtn">
            <span id="buttonText">Find Biomarkers</span>
            <span id="loadingSpinner" style="display: none;"><span class="loading-spinner"></span></span>
          </button>
        </div>
        <div class="recent-searches">
          <div class="recent-search-tag">Mantle cell lymphoma</div>
          <div class="recent-search-tag">Non-small cell lung cancer</div>
          <div class="recent-search-tag">Breast cancer</div>
          <div class="recent-search-tag">Colorectal cancer</div>
          <div class="recent-search-tag">Acute myeloid leukemia</div>
        </div>
      </div>
      <div class="output-container">
        <div id="output" class="biomarker-results">
          <div class="empty-state">
            <div class="empty-icon"><i class="fas fa-dna"></i></div>
            <h3 class="empty-title">Search for biomarkers</h3>
            <p class="empty-message">Enter a cancer type or disease name above to discover relevant biomarkers</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ========= Config =========
    const CF_GET_BIOMARKERS = "https://us-central1-biomarker-matchmaker.cloudfunctions.net/getBiomarkers";
    const OT_GQL = "https://api.platform.opentargets.org/api/v4/graphql";
    const BACKEND_URL = "http://127.0.0.1:8080"; // your Express server (has /drugWarning and /actionability)

    // ========= DOM refs =========
    const input = document.getElementById("diseaseInput");
    const output = document.getElementById("output");
    const btn = document.getElementById("getBiomarkersBtn");
    const buttonText = document.getElementById("buttonText");
    const loadingSpinner = document.getElementById("loadingSpinner");
    const recentSearchTags = document.querySelectorAll(".recent-search-tag");
    const autocompleteList = document.getElementById("autocomplete-list");

    let diseaseNames = [];

    // ========= Utils =========
    const esc = s => String(s ?? "").replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
    const clamp01 = x => Math.max(0, Math.min(1, isFinite(+x) ? +x : 0));
    const pct = x => Math.round(clamp01(x) * 100);

    function insertAfter(elem, html) {
      const wrapper = document.createElement("div");
      wrapper.innerHTML = html;
      const node = wrapper.firstElementChild;
      elem.parentNode.insertBefore(node, elem.nextSibling);
      return node;
    }

    // Collapsible factory
    function renderCollapsible(title, innerHtml, open=false) {
      const expanded = open ? 'true' : 'false';
      const contentOpenClass = open ? 'open' : '';
      return `
        <div class="collapsible">
          <button class="collapsible-header" aria-expanded="${expanded}">
            <span>${esc(title)}</span>
            <i class="chev fas fa-chevron-down"></i>
          </button>
          <div class="collapsible-content ${contentOpenClass}">
            ${innerHtml}
          </div>
        </div>
      `;
    }

    // Delegate clicks for all collapsibles
    document.addEventListener('click', (e) => {
      const header = e.target.closest('.collapsible-header');
      if (!header) return;
      const wrap = header.parentElement;
      const content = wrap.querySelector('.collapsible-content');
      const expanded = header.getAttribute('aria-expanded') === 'true';
      header.setAttribute('aria-expanded', String(!expanded));
      content.classList.toggle('open', !expanded);
    });

    // ========= Open Targets helpers =========
    async function otFetch(query, variables={}) {
      const r = await fetch(OT_GQL, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ query, variables })
      });
      const j = await r.json().catch(()=> ({}));
      if (!r.ok) throw new Error("OpenTargets error");
      return j;
    }

    async function lookupEfoIdByName(name) {
      const q = `
        query Q($q: String!) {
          search(queryString: $q) { hits { id name entity } }
        }
      `;
      const j = await otFetch(q, { q: name });
      const hit = j?.data?.search?.hits?.find(h => h.entity === "disease");
      return hit?.id || null;
    }

    async function getTargetPrioritisation(ensemblId) {
      const q = `
        query T($id: String!) {
          target(ensemblId: $id) {
            prioritisation { items { key value } }
          }
        }
      `;
      const j = await otFetch(q, { id: ensemblId });
      const items = j?.data?.target?.prioritisation?.items || [];
      const get = k => items.find(it => it?.key === k)?.value;
      const isInMembrane = +get("isInMembrane") === 1;
      const isSecreted   = +get("isSecreted")   === 1;
      const tissueSpecificity  = clamp01(get("tissueSpecificity"));
      const tissueDistribution = clamp01(get("tissueDistribution"));
      let location = "Intracellular";
      if (isInMembrane && isSecreted) location = "Membrane & Secreted";
      else if (isInMembrane) location = "Membrane";
      else if (isSecreted)   location = "Secreted";
      return { location, tissueSpecificity, tissueDistribution };
    }

    // Known drugs for this disease & target
    async function getKnownDrugsForDisease(efoId, ensemblId, size=500) {
      const q = `
        query KD($efoId: String!, $size: Int!) {
          disease(efoId: $efoId) {
            knownDrugs(size: $size) {
              rows {
                phase
                drugType
                mechanismOfAction
                urls { name url }
                drug { id name }
                target { id }
              }
            }
          }
        }
      `;
      const j = await otFetch(q, { efoId, size });
      const rows = j?.data?.disease?.knownDrugs?.rows || [];
      const filtered = rows.filter(r => r?.target?.id === ensemblId);
      filtered.sort((a,b) => (b?.phase ?? 0) - (a?.phase ?? 0));
      const seen = new Set();
      const out = [];
      for (const r of filtered) {
        const id = r?.drug?.id;
        if (!id || seen.has(id)) continue;
        seen.add(id);
        out.push(r);
        if (out.length >= 6) break;
      }
      return out;
    }

    // ========= Drug warnings (ONLY the warning text) =========
    const drugWarningCache = new Map();
    async function fetchDrugWarning(chemblId) {
      if (!chemblId) return null;
      if (drugWarningCache.has(chemblId)) return drugWarningCache.get(chemblId);
      try {
        const r = await fetch(`${BACKEND_URL}/drugWarning`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ chemblId })
        });
        const j = await r.json();
        drugWarningCache.set(chemblId, j);
        return j;
      } catch {
        drugWarningCache.set(chemblId, null);
        return null;
      }
    }
    function extractWarningsText(drugWarningJson) {
      const d = drugWarningJson?.data?.drug;
      if (!d) return "No reported warnings";
      const bits = [];
      if (d.hasBeenWithdrawn) bits.push("Withdrawn");
      const rows = Array.isArray(d.drugWarnings) ? d.drugWarnings : [];
      for (const w of rows) {
        const txt = (w?.description && String(w.description).trim()) || (w?.toxicityClass && String(w.toxicityClass).trim());
        if (txt) bits.push(txt);
      }
      const text = [...new Set(bits)].join("; ");
      return text || "No reported warnings";
    }

    // ========= Repurpose helper (your Express backend) =========
    async function findRepurposeDiseases(efoId, ensemblId, size = 500) {
      try {
        const r = await fetch(`${BACKEND_URL}/actionability`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ efoId, targetId: ensemblId, size })
        });
        const j = await r.json();
        return Array.isArray(j?.diseases) ? j.diseases : [];
      } catch (e) {
        console.warn("Repurpose fetch failed", e);
        return [];
      }
    }

    // ========= Autocomplete =========
    async function fetchDiseases() {
      try {
        const response = await fetch('../data/combined_diseases.json');
        const data = await response.json();
        diseaseNames = data.data.search.hits.map(hit => hit.object.name);
      } catch (error) {
        console.error("Failed to load disease list:", error);
      }
    }
    function displaySuggestions(matches) {
      if (matches.length > 0) {
        autocompleteList.innerHTML = matches.map(m => `<div class="suggestion-item">${m}</div>`).join('');
        autocompleteList.style.display = 'block';
      } else { autocompleteList.style.display = 'none'; }
    }
    input.addEventListener("input", () => {
      const value = input.value.toLowerCase();
      if (!value) { autocompleteList.style.display = 'none'; return; }
      const matches = diseaseNames.filter(d => d.toLowerCase().includes(value)).slice(0, 10);
      displaySuggestions(matches);
    });
    autocompleteList.addEventListener("click", (e) => {
      if (e.target.classList.contains("suggestion-item")) {
        input.value = e.target.textContent;
        autocompleteList.style.display = 'none';
      }
    });
    document.addEventListener("click", (e) => { if (e.target.id !== 'diseaseInput') autocompleteList.style.display = 'none'; });
    recentSearchTags.forEach(tag => tag.addEventListener("click", () => { input.value = tag.textContent; searchBiomarkers(); }));
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        if (autocompleteList.style.display === 'block') { autocompleteList.style.display = 'none'; }
        else { searchBiomarkers(); }
      }
    });
    btn.addEventListener("click", searchBiomarkers);

    // ========= Main search & render =========
    async function searchBiomarkers() {
      autocompleteList.style.display = 'none';
      const disease = input.value.trim();
      if (!disease) {
        output.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon"><i class="fas fa-search"></i></div>
            <h3 class="empty-title">Please enter a disease name</h3>
            <p class="empty-message">Try searching for conditions like "breast cancer", "multiple myeloma", or "NSCLC"</p>
          </div>`;
        return;
      }
      buttonText.style.display = "none";
      loadingSpinner.style.display = "inline";
      output.innerHTML = "";
      try {
        const response = await fetch(CF_GET_BIOMARKERS, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ disease, size: 20 })
        });
        const data = await response.json();

        if (data.error) {
          output.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon"><i class="fas fa-exclamation-circle"></i></div>
              <h3 class="empty-title">Error</h3>
              <p class="empty-message">${data.error}</p>
            </div>`;
          return;
        }

        const biomarkerList = data.biomarkers.map(b => `
          <div class="biomarker-card fade-in">
            <div class="card-blob"></div>
            <div class="biomarker-type">Classifying...</div>
            <h3 class="biomarker-name">${esc(b.name)}</h3>
            <div class="biomarker-gene">${esc(b.geneName)}</div>

            <div class="biomarker-score">
              <span class="score-label">Score
                <span class="tooltip-icon">?
                  <span class="tooltip">This score (0‚Äì1) reflects how strongly the biomarker is associated with the disease, based on evidence from Open Targets. A higher score means a stronger association.</span>
                </span>
              </span>
              <div class="score-bar-container">
                <div class="score-bar" style="width: ${Math.round((+b.score || 0) * 100)}%"></div>
              </div>
              <span class="score-value">${(+b.score || 0).toFixed(2)}</span>
            </div>

            <p class="biomarker-summary">${esc(b.summary)}</p>

            <!-- enrichment gets injected below -->

            <a href="${esc(b.openTargetsLink)}" target="_blank" class="biomarker-link">View on Open Targets</a>
          </div>
        `).join("");

        output.innerHTML = `
          <div class="result-header fade-in">
            <h2 class="result-title">Top biomarkers for ${esc(data.disease)}</h2>
            <span class="result-count">${data.biomarkers.length} found</span>
          </div>
          <div class="biomarker-grid">${biomarkerList}</div>
        `;

        await enrichCards(data.disease);

        // Classification labels
        const typeSpans = document.querySelectorAll(".biomarker-type");
        const summaries = document.querySelectorAll(".biomarker-summary");
        summaries.forEach(async (summaryElem, i) => {
          const summaryText = summaryElem.textContent;
          const biomarkerName = document.querySelectorAll(".biomarker-name")[i]?.textContent || "";
          const diseaseName = data.disease;
          try {
            const classifyRes = await fetch("https://us-central1-biomarker-matchmaker.cloudfunctions.net/classifyBiomarker", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ biomarker: biomarkerName, disease: diseaseName, description: summaryText })
            });
            const classifyData = await classifyRes.json();
            if (classifyData.type) {
              const typeText = classifyData.type.toLowerCase();
              const formatted = classifyData.type.charAt(0).toUpperCase() + classifyData.type.slice(1).toLowerCase();
              typeSpans[i].textContent = formatted;
              if (typeText.includes("predictive")) typeSpans[i].classList.add("predictive");
              else if (typeText.includes("prognostic")) typeSpans[i].classList.add("prognostic");
              else if (typeText.includes("diagnostic")) typeSpans[i].classList.add("diagnostic");
            } else { typeSpans[i].textContent = "Not classified"; }
          } catch { typeSpans[i].textContent = "Not classified"; }
        });

      } catch (err) {
        console.error(err);
        output.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon"><i class="fas fa-exclamation-circle"></i></div>
            <h3 class="empty-title">Something went wrong</h3>
            <p class="empty-message">Please try again later.</p>
          </div>
        `;
      } finally {
        buttonText.style.display = "inline";
        loadingSpinner.style.display = "none";
      }
    }

    // ========= Enrichment (Protein expression toggle + Drugs + Repurposing rule) =========
    async function enrichCards(diseaseName) {
      const efoId = await lookupEfoIdByName(diseaseName).catch(() => null);
      const cards = document.querySelectorAll(".biomarker-card");

      for (let i = 0; i < cards.length; i++) {
        const card = cards[i];
        const link = card.querySelector(".biomarker-link")?.getAttribute("href") || "";
        const ensemblId = (link.match(/\/target\/([^/?#]+)/) || [])[1] || null;
        const sumEl = card.querySelector(".biomarker-summary");
        if (!ensemblId || !sumEl) continue;

        try {
          // --- Protein expression (collapsible) ---
          const pri = await getTargetPrioritisation(ensemblId);
          const proteinInner = `
            <div class="biomarker-gene" style="margin-bottom:10px;font-size:15px;">
              <strong>Location:</strong> ${esc(pri.location)}
            </div>
            <div class="biomarker-score">
              <span class="score-label">Specificity
                <span class="tooltip-icon">?
                  <span class="tooltip">How specifically the target is expressed across tissues. Closer to 1 means more tissue-specific.</span>
                </span>
              </span>
              <div class="score-bar-container"><div class="score-bar" style="width:${pct(pri.tissueSpecificity)}%"></div></div>
              <span class="score-value">${pri.tissueSpecificity.toFixed(2)}</span>
            </div>
            <div class="biomarker-score">
              <span class="score-label">Distribution
                <span class="tooltip-icon">?
                  <span class="tooltip">How widely the target is distributed across tissues. Closer to 1 means broader distribution.</span>
                </span>
              </span>
              <div class="score-bar-container"><div class="score-bar" style="width:${pct(pri.tissueDistribution)}%"></div></div>
              <span class="score-value">${pri.tissueDistribution.toFixed(2)}</span>
            </div>
          `;
          insertAfter(sumEl, renderCollapsible("Protein expression", proteinInner, false));

          // --- Drugs ---
          let drugsInner = "";
          let haveDrugs = false;

          if (efoId) {
            const drugs = await getKnownDrugsForDisease(efoId, ensemblId);
            if (drugs.length) {
              haveDrugs = true;
              const itemHtmls = await Promise.all(drugs.map(async d => {
                const name = esc(d?.drug?.name || "Unknown drug");
                const chembl = esc(d?.drug?.id || "");
                const type = esc(d?.drugType || "Type N/A");
                const phase = d?.phase != null ? `Phase ${d.phase}${d.phase === 4 ? " (approved)" : ""}` : "Phase N/A";
                const refs = (d?.urls || []).slice(0,2).map((u,i) =>
                  `<a href="${esc(u.url)}" target="_blank" rel="noopener" title="${esc(u.name||'Source')}">${i+1}</a>`
                ).join(", ");

                // warnings (best-effort)
                let warningsText = "No reported warnings";
                try {
                  const warnJson = await fetchDrugWarning(chembl);
                  warningsText = extractWarningsText(warnJson || {});
                } catch {}

                return `
                  <li>
                    <div class="drug-name">${name} <span class="chembl">(${chembl})</span></div>
                    <div class="drug-detail"> - Drug Type: ${type}</div>
                    <div class="drug-detail"> - Mechanism of Action: ${esc(d?.mechanismOfAction || "N/A")}</div>
                    <div class="drug-detail"> - Clinical Phase: ${phase} ${refs ? `<sup>[${refs}]</sup>` : ""}</div>
                    <div class="drug-detail"> - Warnings: ${esc(warningsText)}</div>
                  </li>`;
              }));

              drugsInner += `
                <div class="treatments">
                  <ul class="treatments-list">${itemHtmls.join("")}</ul>
                </div>`;
            }
          }

          // Repurposing ONLY if no drugs found
          if (!haveDrugs && efoId) {
            const repurpose = await findRepurposeDiseases(efoId, ensemblId);
            if (repurpose.length) {
              const lis = repurpose.slice(0, 8)
                .map(d => `<li>${esc(d.name)} <span class="repurpose-efo">(${esc(d.id)})</span></li>`)
                .join("");
              drugsInner += `
                <div class="repurpose">
                  <div class="repurpose-title">Potential repurposing from:</div>
                  <ul class="repurpose-list">${lis}</ul>
                </div>`;
            }
          }

          if (drugsInner) {
            insertAfter(card.querySelector(".collapsible:last-of-type") || sumEl, renderCollapsible("Drugs", drugsInner, false));
          }

        } catch (e) {
          console.warn("Enrichment failed", e);
        }
      }
    }

    // ========= Boot =========
    window.addEventListener('load', () => { input.value = ""; fetchDiseases(); });
  </script>
</body>
</html>
